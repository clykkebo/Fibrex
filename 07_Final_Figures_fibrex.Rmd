---
title: "Fibrex Alpha Diversity"
author: "masmo, caly"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    toc_depth: 4
    collapsed: false
    code_folding: hide
    number_sections: true
knit: (function(inputFile, encoding) { 
    rmarkdown::render(
        inputFile, encoding = encoding,
        output_dir = file.path(dirname(inputFile),"output"),
        output_file = paste0("Fibrex_", Sys.Date(), "_AlphaDiversity.html")) 
    })
params:
    input: "R_objects/Phyloseq.Rdata"
    batch: "Run"
    indeces: "Observed|Evenness|Shannon|FaithPD|Chao1"
    COL: !r c("LF_CTRL" = "#a5cee3","LF_PFOS" = "#1778b6","HF_CTRL" = "#b4d88a","HF_PFOS" = "#30a148") # based on feed_treat and colorscheme from scale_color_brewer(palette = "Paired")
---

# ARTICLE FIGURES {.tabset .tabset-fade .tabset-pills}

This Rmarkdown contains the commands necessary to perform alpha diversity analysis of the output from the DF_GMH_PIPELINE. It is expected that the data has been imported, cleaned, and saved following the script 1_Import_QC.Rmd prior to using this script. I recommend visiting the ["Analysis of community ecology data in R"](https://www.davidzeleny.net/anadat-r/doku.php/en:start) to read about the theory behind the alpha and beta diversity and examples of the necessary R-code to execute them. Other excellent source of help is the R [cheat-sheets](https://www.rstudio.com/resources/cheatsheets/) and for problems related to Rmarkdown I suggest this [online Book](https://bookdown.org/yihui/rmarkdown/).

Alpha diversity, also called "within sample diversity" is calculated for each sample individually and is independent of all other samples. Alpha diversity is sensitive to sequencing depth, so rarefaction must be done first.

## SETUP

```{r setup, eval=TRUE, echo=TRUE, message=FALSE,warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load libraries
library(tidyverse)
library(phyloseq)
library(ggpubr)
library(rstatix)
library(kableExtra)
library(picante)
library(plotly)
library(cowplot)
library(GMHmicrobiome)
library(ggrepel)
library(forcats)

# Create used folders if missing
if (!file.exists("R_objects")) dir.create(file.path(getwd(), "R_objects"))
if (!file.exists("plots")) dir.create(file.path(getwd(), "plots"))
if (!file.exists("plots/figures")) dir.create(file.path(getwd(), "plots/figures"))
if (!file.exists("scripts")) dir.create(file.path(getwd(), "scripts"))

# Save params
saveRDS(params, file = "R_objects/fig_params.RDS")
```

## SCRIPTS
```{r}
adiv_batch_effect <- function(INNER.VAR, OUTER.VAR, MTRL, DAY) {
  load(params$input)
  adat <- data.frame(sample_data(phy))
  adat <- adat[adat$material == MTRL & adat$day == DAY,]
  
  # Remove samples with incomplete metadata
  adat <- adat[!is.na(adat[,INNER.VAR]) & !is.na(adat[,OUTER.VAR]),]
  adat[,OUTER.VAR] <- as.factor(adat[,OUTER.VAR])
  adat[,INNER.VAR] <- as.factor(adat[,INNER.VAR])
  
  # Determine if any batch effect might influence your data
  ## Calculate distribution counts
  freq.t <- with(adat, table(get(params$batch), feed, exclude = NULL))
  freq.t
  
  ## Determine distribution percentages
  pct.freq.t <- prop.table(freq.t,2)*100
  
  ## Test if any difference is significant (if not significant the batch effect should be negligible)
  chisq <- chisq_test(freq.t)
  output <- list(freq.t, pct.freq.t, chisq)
  output
  return(output)
}

# Process alpha divertsity data for a material and day and create combined plot with wilcoxon statistics
adiv_output <- function(INNER.VAR, OUTER.VAR, MTRL, DAY) {
  load(params$input)
  adat <- data.frame(sample_data(phy))
  adat <- adat[adat$material == MTRL & adat$day == DAY,]
  
  # Remove samples with incomplete metadata
  adat <- adat[!is.na(adat[,INNER.VAR]) & !is.na(adat[,OUTER.VAR]),]
  adat[,OUTER.VAR] <- as.factor(adat[,OUTER.VAR])
  adat[,INNER.VAR] <- as.factor(adat[,INNER.VAR])
  
  INDECES <- c("Observed","Evenness","Shannon","FaithPD")
  
  #### Test project variable
  for (i in INDECES) {
      fit <- aov(as.formula(paste(i, "~", OUTER.VAR,"*",INNER.VAR, sep = " ")), data = adat)
      aov <- anova(fit)
      thsd <- TukeyHSD(fit)
      
      ## Calculate stats for inner variable
      # Perform pairwise comparisons
      stat.test <- adat %>%
        group_by(.data[[OUTER.VAR]]) %>%
        wilcox_test(as.formula(paste(i, "~", INNER.VAR, sep = " "))) %>%
        adjust_pvalue(method = "BH") %>%
        add_significance("p.adj") %>% 
        add_xy_position(x = OUTER.VAR, dodge = 0.8) %>%
        p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
      
      ## Calculate stats for outer variable
      # Perform pairwise comparisons
      stat.test2 <- adat %>%
        wilcox_test(as.formula(paste(i,"~", OUTER.VAR, sep = " "))) %>%
        adjust_pvalue(method = "BH") %>%
        add_significance("p.adj") %>% 
        add_xy_position(x = OUTER.VAR) %>%
        p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
      
      # Adjust y value for outer p-values
      stat.test2$y.position <- max(stat.test$y.position)*1.1
      
      # Create plot
      p <- ggboxplot(adat, x = OUTER.VAR, y = i,
                color = INNER.VAR,
                fill = INNER.VAR,
                add = "jitter",
                add.params = list(size = 1)) +
        scale_fill_manual(values = params$COL, name = "Group", labels = c("HF_CTRL" = "HF-CTRL","HF_PFOS" = "HF-PFOS","LF_CTRL" = "LF-CTRL","LF_PFOS" = "LF-PFOS")) +
        scale_color_manual(values = c("black","black","black","black")) +
        guides(color = "none") +
        theme(axis.title.x = element_blank())
      
      # Add p-values
      if (i == "Observed") {
        p.obs <- p + stat_pvalue_manual(stat.test, label = "p.adj.signif",tip.length = 0, hide.ns = TRUE, color = "red")
        p.obs <- p.obs + stat_pvalue_manual(stat.test2, label = "p.adj.signif",tip.length = 0, step.increase = 0.1, hide.ns = TRUE)
        obs <- list(fit = fit, ANOVA = aov, TukeyHSD = thsd)
      } else if (i == "Evenness") {
        p.eve <- p + stat_pvalue_manual(stat.test, label = "p.adj.signif",tip.length = 0, hide.ns = TRUE, color = "red")
        p.eve <- p.eve + stat_pvalue_manual(stat.test2, label = "p.adj.signif",tip.length = 0, step.increase = 0.1, hide.ns = TRUE)
        eve <- list(fit = fit, ANOVA = aov, TukeyHSD = thsd)
      } else if (i == "Shannon") {
        p.sha <- p + stat_pvalue_manual(stat.test, label = "p.adj.signif",tip.length = 0, hide.ns = TRUE, color = "red")
        p.sha <- p.sha + stat_pvalue_manual(stat.test2, label = "p.adj.signif",tip.length = 0, step.increase = 0.1, hide.ns = TRUE)
        sha <- list(fit = fit, ANOVA = aov, TukeyHSD = thsd)
      } else if (i == "FaithPD") {
        p.fpd <- p + stat_pvalue_manual(stat.test, label = "p.adj.signif",tip.length = 0, hide.ns = TRUE, color = "red")
        p.fpd <- p.fpd + stat_pvalue_manual(stat.test2, label = "p.adj.signif",tip.length = 0, step.increase = 0.1, hide.ns = TRUE)
        fph <- list(fit = fit, ANOVA = aov, TukeyHSD = thsd)
      }
  }
      adiv.plot <- ggarrange(p.obs,p.eve,p.sha,p.fpd, nrow = 1, labels = c("A)","B)","C)","D)"), common.legend = TRUE,legend = "top")
      adiv.plot

      suppressMessages(ggsave(filename = paste0("plots/adiv/alpha_",DAY,"/adiv_",MTRL,"_",DAY,"_nested.png"), plot = adiv.plot, device = "png", units = "mm", width = 350, height = 100, dpi = 300))
      suppressMessages(ggsave(filename = paste0("plots/adiv/alpha_",DAY,"/adiv_",MTRL,"_",DAY,"_nested.pdf"), plot = adiv.plot, device = "pdf", units = "mm", width = 350, height = 100, dpi = 300))
      # output <- list(adiv.plot,obs.fit,obs.aov,obs.thsd,eve.fit,eve.aov,eve.thsd,sha.fit,sha.aov,sha.thsd,fph.fit,fph.aov,fph.thsd)
      # output
      return(list(plot = adiv.plot, Observed = obs, Evenness = eve, Shannon = sha, FaithPH = fph))
}


adiv_day <- function(INNER.VAR, OUTER.VAR, MTRL, DAY) {
  load(params$input)
  adat <- data.frame(sample_data(phy))
  adat <- adat[adat$material == MTRL & adat$day == DAY,]
  
  # Remove samples with incomplete metadata
  adat <- adat[!is.na(adat[,INNER.VAR]) & !is.na(adat[,OUTER.VAR]),]
  adat[,OUTER.VAR] <- as.factor(adat[,OUTER.VAR])
  adat[,INNER.VAR] <- as.factor(adat[,INNER.VAR])
    
      
  ### Observed richness
  fit <- aov(as.formula(paste("Observed ~", OUTER.VAR,"*",INNER.VAR, sep = " ")), data = adat)
  anova(fit)
  TukeyHSD(fit)
  
  ## Calculate stats for inner variable
  # Perform pairwise comparisons
  stat.test <- adat %>%
    group_by(.data[[OUTER.VAR]]) %>%
    wilcox_test(as.formula(paste("Observed ~", INNER.VAR, sep = " "))) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance("p.adj") %>% 
    add_xy_position(x = OUTER.VAR, dodge = 0.8) %>%
    p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
  
  ## Calculate stats for outer variable
  # Perform pairwise comparisons
  stat.test2 <- adat %>%
    wilcox_test(as.formula(paste("Observed ~", OUTER.VAR, sep = " "))) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance("p.adj") %>% 
    add_xy_position(x = OUTER.VAR) %>%
    p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
  
  # Adjust y value for outer p-values
  stat.test2$y.position <- max(stat.test$y.position)*1.1
  
  # Create plot
  p <- ggboxplot(adat, x = OUTER.VAR, y = "Observed",
            color = INNER.VAR,
            fill = INNER.VAR,
            add = "jitter",
            add.params = list(size = 1)) +
    scale_fill_manual(values = params$COL, name = "Group", labels = c("HF_CTRL" = "HF-CTRL","HF_PFOS" = "HF-PFOS","LF_CTRL" = "LF-CTRL","LF_PFOS" = "LF-PFOS")) +
    scale_color_manual(values = c("black","black","black","black")) +
    guides(color = "none") +
    theme(axis.title.x = element_blank())
  
  # Add p-values
  p.obs <- p + stat_pvalue_manual(stat.test, label = "p.adj.format",tip.length = 0, color = "red", hide.ns = TRUE)
  p.obs <- p.obs + stat_pvalue_manual(stat.test2, label = "p.adj.format",tip.length = 0, step.increase = 0.1, hide.ns = TRUE)
  
  ### Evenness
  fit <- aov(as.formula(paste("Evenness ~", OUTER.VAR,"*",INNER.VAR, sep = " ")), data = adat)
  anova(fit)
  TukeyHSD(fit)
  
  ## Calculate stats for inner variable
  # Perform pairwise comparisons
  stat.test <- adat %>%
    group_by(.data[[OUTER.VAR]]) %>%
    wilcox_test(as.formula(paste("Evenness ~", INNER.VAR, sep = " "))) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance("p.adj") %>% 
    add_xy_position(x = OUTER.VAR, dodge = 0.8) %>%
    p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
  
  ## Calculate stats for outer variable
  # Perform pairwise comparisons
  stat.test2 <- adat %>%
    wilcox_test(as.formula(paste("Evenness ~", OUTER.VAR, sep = " "))) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance("p.adj") %>% 
    add_xy_position(x = OUTER.VAR) %>%
    p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
  
  # Adjust y value for outer p-values
  stat.test2$y.position <- max(stat.test$y.position)*1.1
  
  # Create plot
  p <- ggboxplot(adat, x = OUTER.VAR, y = "Evenness",
            color = INNER.VAR,
            fill = INNER.VAR,
            add = "jitter",
            add.params = list(size = 1)) +
    scale_fill_manual(values = params$COL, name = "Group", labels = c("HF_CTRL" = "HF-CTRL","HF_PFOS" = "HF-PFOS","LF_CTRL" = "LF-CTRL","LF_PFOS" = "LF-PFOS")) +
    scale_color_manual(values = c("black","black","black","black")) +
    guides(color = "none") +
    theme(axis.title.x = element_blank())
  # Add p-values
  p.eve <- p + stat_pvalue_manual(stat.test, label = "p.adj.format",tip.length = 0, color = "red", hide.ns = TRUE)
  p.eve <- p.eve + stat_pvalue_manual(stat.test2, label = "p.adj.format",tip.length = 0, step.increase = 0.1, hide.ns = TRUE)
  
  ### Shannon diversity index
  fit <- aov(as.formula(paste("Shannon ~", OUTER.VAR,"*",INNER.VAR, sep = " ")), data = adat)
  anova(fit)
  TukeyHSD(fit)
  
  ## Calculate stats for inner variable
  # Perform pairwise comparisons
  stat.test <- adat %>%
    group_by(.data[[OUTER.VAR]]) %>%
    wilcox_test(as.formula(paste("Shannon ~", INNER.VAR, sep = " "))) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance("p.adj") %>% 
    add_xy_position(x = OUTER.VAR, dodge = 0.8) %>%
    p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
  
  ## Calculate stats for outer variable
  # Perform pairwise comparisons
  stat.test2 <- adat %>%
    wilcox_test(as.formula(paste("Shannon ~", OUTER.VAR, sep = " "))) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance("p.adj") %>% 
    add_xy_position(x = OUTER.VAR) %>%
    p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
  
  # Adjust y value for outer p-values
  stat.test2$y.position <- max(stat.test$y.position)*1.1
  
  # Create plot
  p <- ggboxplot(adat, x = OUTER.VAR, y = "Shannon",
            color = INNER.VAR,
            fill = INNER.VAR,
            add = "jitter",
            add.params = list(size = 1)) +
    scale_fill_manual(values = params$COL, name = "Group", labels = c("HF_CTRL" = "HF-CTRL","HF_PFOS" = "HF-PFOS","LF_CTRL" = "LF-CTRL","LF_PFOS" = "LF-PFOS")) +
    scale_color_manual(values = c("black","black","black","black")) +
    guides(color = "none") +
    theme(axis.title.x = element_blank())
  # Add p-values
  p.sha <- p + stat_pvalue_manual(stat.test, label = "p.adj.format",tip.length = 0, color = "red", hide.ns = TRUE)
  p.sha <- p.sha + stat_pvalue_manual(stat.test2, label = "p.adj.format",tip.length = 0, step.increase = 0.1, hide.ns = TRUE)
  
  ### FaithPD diversity index
  fit <- aov(as.formula(paste("FaithPD ~", OUTER.VAR,"*",INNER.VAR, sep = " ")), data = adat)
  anova(fit)
  TukeyHSD(fit)
  
  ## Calculate stats for inner variable
  # Perform pairwise comparisons
  stat.test <- adat %>%
    group_by(.data[[OUTER.VAR]]) %>%
    wilcox_test(as.formula(paste("FaithPD ~", INNER.VAR, sep = " "))) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance("p.adj") %>% 
    add_xy_position(x = OUTER.VAR, dodge = 0.8) %>%
    p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
  
  ## Calculate stats for outer variable
  # Perform pairwise comparisons
  stat.test2 <- adat %>%
    wilcox_test(as.formula(paste("FaithPD ~", OUTER.VAR, sep = " "))) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance("p.adj") %>% 
    add_xy_position(x = OUTER.VAR) %>%
    p_format("p.adj", accuracy = 0.0001, trailing.zero = TRUE, new.col = TRUE)
  
  # Adjust y value for outer p-values
  stat.test2$y.position <- max(stat.test$y.position)*1.1
  
  # Create plot
  p <- ggboxplot(adat, x = OUTER.VAR, y = "FaithPD",
            color = INNER.VAR,
            fill = INNER.VAR,
            add = "jitter",
            add.params = list(size = 1)) +
    scale_fill_manual(values = params$COL, name = "Group", labels = c("HF_CTRL" = "HF-CTRL","HF_PFOS" = "HF-PFOS","LF_CTRL" = "LF-CTRL","LF_PFOS" = "LF-PFOS")) +
    scale_color_manual(values = c("black","black","black","black")) +
    guides(color = "none") +
    theme(axis.title.x = element_blank())
  # Add p-values
  p.fpd <- p + stat_pvalue_manual(stat.test, label = "p.adj.format",tip.length = 0, color = "red", hide.ns = TRUE)
  p.fpd <- p.fpd + stat_pvalue_manual(stat.test2, label = "p.adj.format",tip.length = 0, step.increase = 0.1, hide.ns = TRUE)
  ### Create output plot
  # filename <- paste0("plots/adiv/alpha_d0/adiv_",var1,"_",var2,"_nested.png")
  # filename2 <- paste0("plots/adiv/alpha_d0/adiv_",var1,"_",var2,"_nested.pdf")
  adiv.plot <- ggarrange(p.obs,p.eve,p.sha,p.fpd, nrow = 1, labels = c("A)","B)","C)","D)"), common.legend = TRUE,legend = "top")
  adiv.plot
  suppressMessages(ggsave(filename = paste0("plots/adiv/alpha_",DAY,"/adiv_",MTRL,"_",DAY,"_nested.png"), plot = adiv.plot, device = "png", units = "mm", width = 350, height = 100, dpi = 300))
  suppressMessages(ggsave(filename = paste0("plots/adiv/alpha_",DAY,"/adiv_",MTRL,"_",DAY,"_nested.pdf"), plot = adiv.plot, device = "pdf", units = "mm", width = 350, height = 100, dpi = 300))
  
  return(adiv.plot)
}

rm_legend <- function(p){p + theme(legend.position = "none")}

save(adiv_day,adiv_batch_effect,adiv_output, rm_legend, file = "scripts/adiv.Rdata")


```

# Main figures
## Figure 6: Faecal Alpha & Beta Diversity
```{r}
params <- readRDS("R_objects/Adiv_params.RDS")
load("scripts/adiv.Rdata")

# Load rdata files with scfa plots
div.plots <- c("plots/adiv/timeline/adiv_figures.Rdata","plots/bdiv/timeline/Feces_HF_no0/PCoA_plot_Feces_HF_no0.Rdata")
lapply(div.plots, load,.GlobalEnv)
# rm_legend <- function(p){p + theme(legend.position = "none")}

#Renaming bdiv HF plots
hf.bray.perm <- bray.perm
hf.bray.plot <- rm_legend(bray.plot)
hf.jac.perm <- jac.perm
hf.jac.plot <- rm_legend(jac.plot)
hf.unif.perm <- unif.perm
hf.unif.plot <- rm_legend(unif.plot)
hf.wuf.perm <- wuf.perm
hf.wuf.plot <- rm_legend(wuf.plot)
hf.ait.perm <- ait.perm
hf.ait.plot <- rm_legend(ait.plot)

# Load bdiv LF plots
load("plots/bdiv/timeline/Feces_LF_no0/PCoA_plot_Feces_LF_no0.Rdata")

#Renaming bdiv HF plots
lf.bray.perm <- bray.perm
lf.bray.plot <- rm_legend(bray.plot)
lf.jac.perm <- jac.perm
lf.jac.plot <- rm_legend(jac.plot)
lf.unif.perm <- unif.perm
lf.unif.plot <- rm_legend(unif.plot)
lf.wuf.perm <- wuf.perm
lf.wuf.plot <- rm_legend(wuf.plot)
lf.ait.perm <- ait.perm
lf.ait.plot <- rm_legend(ait.plot)

load("plots/bdiv/timeline/Feces_no20/PCoA_plot_Feces_no20.Rdata")

legend <- get_legend(bray.plot)

#remove leftovers
rm(bray.perm,bray.plot,jac.perm,jac.plot,unif.perm,unif.plot,wuf.perm,wuf.plot,ait.perm,ait.plot)


p.adiv <- ggarrange(p.obs,p.sha,p.fpd, 
                    nrow = 1, 
                    labels = c("A","B","C"),
                    common.legend = TRUE,
                    legend = "top",
                    font.label = list(size = 24, face = "bold"))
p.adiv

p.bdiv <- ggarrange(hf.bray.plot, hf.jac.plot, lf.bray.plot, lf.jac.plot,
                   ncol = 2, nrow = 2,
                   align = "hv",
                   label.x = 0,
                   font.label = list(size = 24, face = "bold"),
                   labels = c("C","D","E","F"))
p.bdiv

p.all <- ggarrange(p.adiv, legend, p.bdiv,
                   ncol = 1, nrow = 3,
                   heights = c(3,0.5,4))
p.all

# Save combined graphics
ggsave(filename = "plots/figures/diversity_combined_bray_jac.png", p.all, device = "png", dpi = 300, height = 350, width = 350, units = "mm")
ggsave(filename = "plots/figures/diversity_combined_bray_jac.pdf", p.all, device = "pdf", dpi = 300, height = 350, width = 350, units = "mm")

# clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())
```
## Figure AX: PHYLA

The following section summarises relative abundances and the ratio between Firmicutes and Bacteroidetes in data daily and in respect to factors such as HF/LF feed and PFOS exposure. 

```{r}
# load data 
load("R_objects/Agglomerated.RData")
params <- readRDS("R_objects/params_description.RDS")
LIST.DAY <- c("d0","d08","d12","d16","d21", "all")
DIETS <- c("HF","LF")
LIST.TR <- c("CTRL","PFOS", "both")
LVL <- "Phylum"

# Prepare dataframe
df <- data.frame()

# Run calcualtions
suppressMessages({suppressWarnings({
for (DIET in DIETS) {
  #print(DIET)
  load("R_objects/Agglomerated.RData")
  phy.feed <- phy.ph
  phy.feed <- subset_samples(phy.feed, feed == DIET)
  
  for (DAY in LIST.DAY) {
    if (DAY == "all") {
      print("## All days selected")
      phy.day <- phy.feed
    } else {
      print(paste0("## Day ",DAY," selected"))
      phy.day <- subset_samples(phy.feed, day == DAY)
    }
    
    for (TR in LIST.TR) {
      if (TR == "both") {
        # print("## Both treatment groups selected")
        phy.tr <- phy.day
      } else {
        # print(paste0("## Treatment ",TR," selected"))
        phy.tr <- subset_samples(phy.day, treatment == TR)
      }
      # Transform data
      phy.rel <- transform_sample_counts(phy.tr, fun = function(x) x/sum(x)*100)
      dat <- psmelt(phy.rel)
      
      # Filter by abundance, then rank
      phy.top <- filter_abundance(phy.rel) %>% filter_rank(min.rank = 19)
      
      #Melt data
      dat <- suppressWarnings(psmelt(phy.top))
      
      # Prevent duplicate column names
      colnames(dat)[colnames(dat) %in% c("Taxa","SampleID")] <- paste(colnames(dat)[colnames(dat) %in% c("Taxa","SampleID")], "old", sep = "_")
      
      # Rename relevant columns
      colnames(dat)[c(1,4)] <- c("Taxa","SampleID")
      
      # Sort taxa
      dat.sort <- sort_taxa(dat) 
      
      # rename taxa
      levels(dat.sort$Taxa) <- LETTERS[seq(length(levels(dat.sort$Taxa)))]
      
      # print tax table
      tax <- dat.sort %>% group_by(Taxa, Kingdom, Phylum) %>% summarise(Abundance = mean(Abundance))
      
      # Bacteroidetes-Firmicutes ratio
      Ba <- subset(tax, Phylum == "Bacteroidetes")
      Fi <- subset(tax, Phylum == "Firmicutes")
      Pb <- subset(tax, Phylum == "Proteobacteria")
      if (nrow(Pb) == 0) {
        print(paste0("Zero Preoteobacteria in ",DIET," ",DAY," ",TR))
        df_0 <- c("D","Bacteria","Proteobacteria",0)
        Pb <- data.frame()
        Pb <- rbind(Pb,df_0)
        colnames(Pb) <- c("Taxa","Kingdom","Phylum","Abundance")
        Pb <- transform(Pb, Abundance = as.numeric(Abundance))
        } else {}
      Ac <- subset(tax, Phylum == "Actinobacteria")
      if (nrow(Ac) == 0) {
        print(paste0("Zero Actinobacteria in ",DIET," ",DAY," ",TR))
        df_0 <- c("A","Bacteria","Actinobacteria",0)
        Ac <- data.frame()
        Ac <- rbind(Ac,df_0)
        colnames(Ac) <- c("Taxa","Kingdom","Phylum","Abundance")
        Ac <- transform(Ac, Abundance = as.numeric(Abundance))
        } else {}
      OT_FB <- 100 - (round(Fi$Abundance,3) + round(Ba$Abundance,3))
      OT_ALL <- 100 - (round(Fi$Abundance,3) + round(Ba$Abundance,3) + round(Pb$Abundance,3) + round(Ac$Abundance,3))
      FBR <- Fi$Abundance / Ba$Abundance 
      
      output <- c(DIET, DAY, TR, paste0(DIET,"_",TR), round(Fi$Abundance,3), round(Ba$Abundance,3),round(Pb$Abundance,3),round(Ac$Abundance,3), OT_FB, OT_ALL, FBR) #round(Ab$Abundance,3),
      
      df <- rbind(df, output)
      
    }
  }
}
 })})

# Names columns
colnames(df) <- c("feed","day","treatment","feed_treat",
                  "Firmicutes","Bacteroidetes","Proteobacteria","Actinobacteria","Others_FB","Others_all","FB_ratio")
df
df <- transform(df, Firmicutes = as.numeric(Firmicutes),
                Bacteroidetes = as.numeric(Bacteroidetes),
                Proteobacteria = as.numeric(Proteobacteria),
                Actinobacteria = as.numeric(Actinobacteria),
                Others_FB = as.numeric(Others_FB),
                Others_all = as.numeric(Others_all),
                FB_ratio = as.numeric(FB_ratio))
df
write.csv(df, file = "plots/figures/Phyla_relative_abundance.csv")

# Prepare Firmicutes and Bacteroidetes for plotting
df.fb <- pivot_longer(df, cols = c(Firmicutes, Bacteroidetes, Others_FB), names_to = "Phylum", values_to = "Abundance")
df.fb <- subset(df.fb, treatment != "both" & day != "all")
df.fb

# Plot Firmicutes + Bacteroidetes
p <- ggplot(df.fb, aes(fill = Phylum, y = Abundance, x = feed)) +
  geom_bar(position = "fill", stat = "identity") +
  facet_grid(treatment ~ day, labeller = labeller(day = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21"))) +
  geom_text(aes(label = paste0(round(Abundance,2),"%")), position = position_fill(vjust = 0.5), size = 3, color = "#222222") +
  ggsci::scale_fill_d3(palette = "category20", name = "Phylum", labels = c("Others_FB" = "Others")) +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"), name = "Relative Abundance") +
  theme_pubr(legend = "top", border = TRUE) +
  theme(axis.title.x = element_blank())

p

ggsave(filename = "plots/figures/Firmicutes-Bacteroidetes-ratios.png", plot = p, device = "png", unit = "mm", dpi = 300, height = 150, width = 200)
ggsave(filename = "plots/figures/Firmicutes-Bacteroidetes-ratios.pdf", plot = p, device = "pdf", unit = "mm", dpi = 300, height = 150, width = 200)

# Prepare All for plotting
df.all <- pivot_longer(df, cols = c(Firmicutes, Bacteroidetes, Proteobacteria, Actinobacteria, Others_all), names_to = "Phylum", values_to = "Abundance")
df.all <- subset(df.all, treatment != "both" & day != "all")
df.all

l <- c("Firmicutes", "Bacteroidetes", "Proteobacteria", "Actinobacteria", "Others_all")

df.all$Phylum <- factor(df.all$Phylum, levels = c(l))

if (!file.exists("plots/figures/objects")) dir.create(file.path(getwd(), "plots/figures/objects"))
save(df,df.fb,df.all, file = "plots/figures/objects/phyla_means.Rdata")

# Plot All
p.all <- ggplot(df.all, aes(fill = Phylum, y = Abundance, x = feed)) +
  geom_bar(position = "fill", stat = "identity") +
  facet_grid(treatment ~ day, labeller = labeller(day = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21"))) +
  geom_text(data = df.all[df.all$Phylum %in% c("Firmicutes", "Bacteroidetes", "Proteobacteria"),], aes(label = paste0(round(Abundance,2),"%")), position = position_fill(vjust = 0.5), size = 3) +
  ggsci::scale_fill_d3(palette = "category20", name = "Phylum", labels = c("Others_all" = "Others")) +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"), name = "Relative Abundance") +
  theme_pubr(legend = "top", border = TRUE) +
  theme(axis.title.x = element_blank())

p.all

ggsave(filename = "plots/figures/Phyla_relative_mean_abundance.png", plot = p.all, device = "png", unit = "mm", dpi = 300, height = 150, width = 200)
ggsave(filename = "plots/figures/Phyla_relative_mean_abundance.pdf", plot = p.all, device = "pdf", unit = "mm", dpi = 300, height = 150, width = 200)

# Plot check PFOS
p.pfos <- ggplot(df.all, aes(fill = treatment, y = Abundance, x = day)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_point() +
  facet_grid(feed ~ Phylum, labeller = labeller(day = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21"))) +
  #geom_text(data = df.all[df.all$Phylum %in% c("Firmicutes", "Bacteroidetes", "Proteobacteria"),], aes(label = paste0(round(Abundance,2),"%")), position = position_fill(vjust = 0.5), size = 3) +
  ggsci::scale_fill_d3(palette = "category20", name = "Phylum", labels = c("Others_all" = "Others")) +
  scale_y_continuous(labels = function(x) paste0(x, "%"), name = "Relative Abundance") +
  theme_pubr(legend = "top", border = TRUE) +
  theme(axis.title.x = element_blank())

p.pfos

ggsave(filename = "plots/figures/Phyla_relative_mean_abundance_pfos.png", plot = p.pfos, device = "png", unit = "mm", dpi = 300, height = 150, width = 200)
ggsave(filename = "plots/figures/Phyla_relative_mean_abundance_pfos.pdf", plot = p.pfos, device = "pdf", unit = "mm", dpi = 300, height = 150, width = 200)


# Plot check Diet
p.feed <- ggplot(df.all, aes(fill = feed, y = Abundance, x = day)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  facet_grid(treatment ~ Phylum, labeller = labeller(day = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21"))) +
  #geom_text(data = df.all[df.all$Phylum %in% c("Firmicutes", "Bacteroidetes", "Proteobacteria"),], aes(label = paste0(round(Abundance,2),"%")), position = position_fill(vjust = 0.5), size = 3) +
  ggsci::scale_fill_d3(palette = "category20", name = "Phylum", labels = c("Others_all" = "Others")) +
  scale_y_continuous(labels = function(x) paste0(x, "%"), name = "Relative Abundance") +
  theme_pubr(legend = "top", border = TRUE) +
  theme(axis.title.x = element_blank()) +
  scale_x_discrete(labels = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21"))

p.feed

ggsave(filename = "plots/figures/Phyla_relative_mean_abundance_diet.png", plot = p.feed, device = "png", unit = "mm", dpi = 300, height = 150, width = 200)
ggsave(filename = "plots/figures/Phyla_relative_mean_abundance_diet.pdf", plot = p.feed, device = "pdf", unit = "mm", dpi = 300, height = 150, width = 200)

# Plot check Day
p.day <- ggplot(df.all, aes(fill = day, y = Abundance, x = feed)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  facet_grid(Phylum ~ treatment, scales = "free_y", labeller = labeller(day = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21"))) +
  #geom_text(data = df.all[df.all$Phylum %in% c("Firmicutes", "Bacteroidetes", "Proteobacteria"),], aes(label = paste0(round(Abundance,2),"%")), position = position_fill(vjust = 0.5), size = 3) +
  ggsci::scale_fill_d3(palette = "category20", name = "Phylum", labels = c("Others_all" = "Others", "d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21")) +
  scale_y_continuous(labels = function(x) paste0(x, "%"), name = "Relative Abundance") +
  theme_pubr(legend = "top", border = TRUE) +
  theme(axis.title.x = element_blank()) +
  scale_x_discrete(labels = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21"))

p.day

ggsave(filename = "plots/figures/Phyla_relative_mean_abundance_day.png", plot = p.day, device = "png", unit = "mm", dpi = 300, height = 150, width = 200)
ggsave(filename = "plots/figures/Phyla_relative_mean_abundance_day.pdf", plot = p.day, device = "pdf", unit = "mm", dpi = 300, height = 150, width = 200)

# kable(tax,digits = 2,caption = paste("Taxa plotted", sep = " ")) %>%
#   kable_classic(full_width = F, position = "left")
# clear the environment and release memory
rm(list = ls(all.names = TRUE))
invisible(gc())
```

## Figure AX2: PHYLA

The following section compare relative abundances and the ratio between Firmicutes and Bacteroidetes in data daily and in respect to factors such as HF/LF feed and PFOS exposure. 

```{r}
# load data 
load("R_objects/Agglomerated.RData")
load("plots/figures/objects/phyla_means.Rdata")
params <- readRDS("R_objects/params_description.RDS")
LVL <- "Phylum"

load("R_objects/Agglomerated.RData")
phy.used <- phy.ph

  # Transform data
phy.rel <- transform_sample_counts(phy.used, fun = function(x) x/sum(x)*100)
dat <- psmelt(phy.rel)

# Filter by abundance, then rank
phy.top <- filter_abundance(phy.rel) %>% filter_rank(min.rank = 19)

#Melt data
dat <- suppressWarnings(psmelt(phy.top))

# Prevent duplicate column names
colnames(dat)[colnames(dat) %in% c("Taxa","SampleID")] <- paste(colnames(dat)[colnames(dat) %in% c("Taxa","SampleID")], "old", sep = "_")

# Rename relevant columns
colnames(dat)[c(1,4)] <- c("Taxa","SampleID")

# Sort taxa
dat.sort <- sort_taxa(dat) 

# # rename taxa
levels(dat.sort$Taxa) <- LETTERS[seq(length(levels(dat.sort$Taxa)))]

# print tax table
tax <- dat.sort %>% group_by(Taxa, Kingdom, Phylum) %>% summarise(Abundance = mean(Abundance))

# Subset to phyla and order
dat.used <- subset(dat.sort, Phylum %in% c("Firmicutes", "Bacteroidetes"))
df.all <- subset(df.all, Phylum %in% c("Firmicutes", "Bacteroidetes"))
l <- c("Firmicutes", "Bacteroidetes", "Proteobacteria", "Actinobacteria","Others")
d <- c("d21","d16","d12","d08","d0")

dat.used$Phylum <- factor(dat.used$Phylum, levels = c(l))
dat.used$day <- factor(dat.used$day, levels = c(d))

df.all$Phylum <- factor(df.all$Phylum, levels = c(l))
df.all$day <- factor(df.all$day, levels = c(d))

# Set parameters
PREDICTOR <- c("feed","day","Phylum")
OUTCOME <- "Abundance"
SUBJECT <- "rat_name"

# Create formula
PREDICTOR.F <- ifelse(length(PREDICTOR) > 1, paste(PREDICTOR, collapse = "*"), PREDICTOR)
FORMULA <- as.formula(paste(OUTCOME,PREDICTOR.F, sep = " ~ "))

# Summary samples in groups
dat.used %>% group_by(across(all_of(PREDICTOR))) %>% get_summary_stats(!!sym(OUTCOME), type = "mean_sd")

# Test for outliers
dat.used %>% 
  group_by(across(all_of(PREDICTOR))) %>% 
  identify_outliers(!!sym(OUTCOME))

# Check normality
# Build the linear model
model  <- lm(FORMULA, data = dat.used)
# Create a QQ plot of residuals
ggqqplot(residuals(model))

#Check for variance homogeneity
# Compute Shapiro-Wilk test of normality
shapiro_test(residuals(model))
dat.used %>% levene_test(FORMULA)

# Save result
EQUAL.VAR <- dat.used %>% levene_test(FORMULA) %>% pull(p) > 0.05

## Abundance data is not normally distributed and does not have equal variance
## We use Wilcoxon and Kruskal-Wallis

# Plot for comparing PFOS influence
# Statistics costumed for facet plotting
stat.in <- dat.used %>%
  group_by(Phylum,feed,day) %>%
  wilcox_test(as.formula("Abundance ~ treatment")) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance() %>%
  add_xy_position(x = "feed", dodge = 0.8) %>%
  p_format("p", accuracy = 0.001, trailing.zero = TRUE, new.col = TRUE)
stat.in

stat.out <- dat.used %>%
  group_by(feed, Phylum) %>%
  kruskal_test(as.formula("Abundance ~ day")) %>%
  add_significance() %>%
  p_format("p", accuracy = 0.001, trailing.zero = TRUE, new.col = TRUE)
stat.out

stat.out2 <- dat.used %>%
  group_by(feed, Phylum) %>%
  dunn_test(as.formula("Abundance ~ day"), p.adjust.method = "fdr") %>%
  add_significance() %>%
  add_xy_position(x = "day") %>%
  p_format("p.adj", accuracy = 0.001, trailing.zero = TRUE, new.col = TRUE)
stat.out2

dat.used$feed_treat <- factor(as.character(dat.used$feed_treat))

# Plot check PFOS
p.pfos <- ggplot(dat.used) +
  geom_bar(data = df.all, aes(fill = fct_rev(feed_treat), y = Abundance, x = day), stat = "identity", position = position_dodge()) +
  facet_grid(Phylum ~ feed, labeller = labeller(day = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21"))) +
  #ggsci::scale_fill_d3(palette = "category20", name = "Phylum", labels = c("Others" = "Others")) +
  geom_text(data = df.all, aes(label = paste0(round(Abundance,1),"%"), x = day, y = Abundance/2, group = fct_rev(feed_treat)), position = position_dodge(width = 0.9), size = 3, color = "black") +
  coord_flip() +
  scale_fill_manual(values = params$COL, name = "Group", labels = c("LF_CTRL" = "LF-CTRL","LF_PFOS" = "LF-PFOS","HF_CTRL" = "HF-CTRL","HF_PFOS" = "HF-PFOS"), breaks = c("HF_CTRL","HF_PFOS","LF_CTRL","LF_PFOS"))+
  scale_color_manual(values = c("black","black","black","black")) +
  theme_pubr(legend = "top", border = TRUE) +
  scale_x_discrete(name = "Day", labels = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21")) +
  theme(axis.title.y = element_blank())
p.pfos

p.done <- p.pfos + stat_pvalue_manual(stat.in, label = "p.adj.signif", tip.length = 0, hide.ns = TRUE, color = "red", coord.flip = TRUE) +
  stat_pvalue_manual(stat.out2, label = "p.adj.signif", tip.length = 0, hide.ns = TRUE, y.position = c(75,85,75), coord.flip = TRUE) +
  scale_y_continuous(labels = function(x) paste0(x, "%"), name = "Relative Abundance", limits = c(0,100))
p.done

ggsave(filename = "plots/figures/Firmicutes_Bacteroidetes_relative_abundance.png", plot = p.done, device = "png", unit = "mm", dpi = 300, height = 150, width = 200)
ggsave(filename = "plots/figures/Firmicutes_Bacteroidetes_relative_abundance.pdf", plot = p.done, device = "pdf", unit = "mm", dpi = 300, height = 150, width = 200)

# Plot for comparing group comaprison
# Statistics costumed for facet plotting
stat.in1 <- dat.used %>%
  group_by(feed_treat, Phylum) %>%
  kruskal_test(as.formula("Abundance ~ day")) %>%
  add_significance() %>%
  p_format("p", accuracy = 0.001, trailing.zero = TRUE, new.col = TRUE)
stat.in1

stat.in2 <- dat.used %>%
  group_by(feed_treat, Phylum) %>%
  dunn_test(as.formula("Abundance ~ day"), p.adjust.method = "fdr") %>%
  add_significance() %>%
  add_xy_position(x = "day") %>%
  p_format("p.adj", accuracy = 0.001, trailing.zero = TRUE, new.col = TRUE)
stat.in2

dat.used$feed_treat <- factor(as.character(dat.used$feed_treat))

# Plot check PFOS
p.group <- ggplot(dat.used) +
  geom_bar(data = df.all, aes(fill = fct_rev(feed_treat), y = Abundance, x = day), stat = "identity", position = position_dodge()) +
  geom_point(data = dat.used, aes(x = day, y = Abundance, color = feed_treat), position = position_jitter(width = 0.2), size = 0.5, alpha = 0.8) +
  facet_grid(Phylum ~ feed_treat, labeller = labeller(feed_treat = c("LF_CTRL" = "LF-CTRL","LF_PFOS" = "LF-PFOS","HF_CTRL" = "HF-CTRL","HF_PFOS" = "HF-PFOS"))) +
  #ggsci::scale_fill_d3(palette = "category20", name = "Phylum", labels = c("Others" = "Others")) +
  geom_text(data = df.all, aes(label = paste0(round(Abundance,1),"%"), x = day, y = Abundance/2, group = fct_rev(feed_treat), color = treatment), size = 3) +
  coord_flip() +
  scale_fill_manual(values = params$COL, name = "Group", labels = c("LF_CTRL" = "LF-CTRL","LF_PFOS" = "LF-PFOS","HF_CTRL" = "HF-CTRL","HF_PFOS" = "HF-PFOS"), breaks = c("HF_CTRL","HF_PFOS","LF_CTRL","LF_PFOS"))+
  scale_color_manual(values = c("LF_CTRL" = "#1778b6","LF_PFOS" = "#1748b6","HF_CTRL" = "#84b559","HF_PFOS" = "#306148", "CTRL" = "black","PFOS" = "white")) +
  theme_pubr(legend = "top", border = TRUE) +
  scale_x_discrete(name = "Day", labels = c("d0" = "Day 0","d08" = "Day 8","d12" = "Day 12","d16" = "Day 16","d21" = "Day 21")) +
  theme(axis.title.y = element_blank(), axis.text.x = element_text(angle = 90)) +
  guides(color = "none", alpha = "none")
p.group

p.stat <- p.group + stat_pvalue_manual(stat.in2, label = "p.adj.signif", tip.length = 0, hide.ns = TRUE, coord.flip = TRUE, y.position = c(80,80)) +
  scale_y_continuous(labels = function(x) paste0(x, "%"), name = "Relative Abundance", limits = c(0,100))
p.stat

ggsave(filename = "plots/figures/Firmicutes_Bacteroidetes_relative_abundance_group.png", plot = p.stat, device = "png", unit = "mm", dpi = 300, height = 150, width = 200)
ggsave(filename = "plots/figures/Firmicutes_Bacteroidetes_relative_abundance_group.pdf", plot = p.stat, device = "pdf", unit = "mm", dpi = 300, height = 150, width = 200)

# kable(tax,digits = 2,caption = paste("Taxa plotted", sep = " ")) %>%
#   kable_classic(full_width = F, position = "left")
# clear the environment and release memory
rm(list = ls(all.names = TRUE))
invisible(gc())
```

## Figure AX3: ILEUM DIV
```{r}
load("scripts/adiv.Rdata")

load("plots/adiv/alpha_d08/adiv_Ileum_d08.Rdata")
# renaming
p.eve.8 <- p.eve
p.obs.8 <- p.obs
p.sha.8 <- p.sha
p.fpd.8 <- p.fpd
load("plots/adiv/alpha_d21/adiv_Ileum_d21.Rdata")
p.eve.21 <- p.eve
p.obs.21 <- p.obs
p.sha.21 <- p.sha
p.fpd.21 <- p.fpd
rm(p.eve,p.sha,p.obs,p.fpd)

load("plots/bdiv/timeline/Ileum_HF/PCoA_plot_Ileum_HF.Rdata")
#Renaming bdiv HF plots
hf.bray.perm <- bray.perm
hf.bray.plot <- rm_legend(bray.plot)
hf.jac.perm <- jac.perm
hf.jac.plot <- rm_legend(jac.plot)
hf.unif.perm <- unif.perm
hf.unif.plot <- rm_legend(unif.plot)
hf.wuf.perm <- wuf.perm
hf.wuf.plot <- rm_legend(wuf.plot)
hf.ait.perm <- ait.perm
hf.ait.plot <- rm_legend(ait.plot)

# Load bdiv LF plots
load("plots/bdiv/timeline/Ileum_LF/PCoA_plot_Ileum_LF.Rdata")

#Renaming bdiv HF plots
lf.bray.perm <- bray.perm
lf.bray.plot <- rm_legend(bray.plot)
lf.jac.perm <- jac.perm
lf.jac.plot <- rm_legend(jac.plot)
lf.unif.perm <- unif.perm
lf.unif.plot <- rm_legend(unif.plot)
lf.wuf.perm <- wuf.perm
lf.wuf.plot <- rm_legend(wuf.plot)
lf.ait.perm <- ait.perm
lf.ait.plot <- rm_legend(ait.plot)

load("plots/bdiv/timeline/Ileum/PCoA_plot_Ileum.Rdata")

legend <- get_legend(bray.plot)

#remove leftovers
rm(bray.perm,bray.plot,jac.perm,jac.plot,unif.perm,unif.plot,wuf.perm,wuf.plot,ait.perm,ait.plot)

# Call plots
p.adiv <- ggarrange(p.obs.8,p.sha.8,p.fpd.8, p.obs.21,p.sha.21,p.fpd.21, 
                    nrow = 2, ncol = 3,
                    labels = c("A","","","B","",""),
                    common.legend = TRUE,
                    align = "hv",
                    legend = "top",
                    font.label = list(size = 24, face = "bold"))
p.adiv

p.bdiv <- ggarrange(hf.bray.plot, hf.jac.plot, lf.bray.plot, lf.jac.plot,
                   ncol = 2, nrow = 2,
                   align = "hv",
                   label.x = 0,
                   font.label = list(size = 24, face = "bold"),
                   labels = c("C","D","E","F"))
p.bdiv

p.all <- ggarrange(p.adiv, legend, p.bdiv,
                   ncol = 1, nrow = 3,
                   heights = c(3,0.5,4))
p.all

# Save combined graphics
ggsave(filename = "plots/figures/diversity_ileum_combined_bray_jac.png", p.all, device = "png", dpi = 300, height = 350, width = 350, units = "mm")
ggsave(filename = "plots/figures/diversity_ileum_combined_bray_jac.pdf", p.all, device = "pdf", dpi = 300, height = 350, width = 350, units = "mm")

# clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```

## Figure AX3: CAECUM DIV
```{r}
load("scripts/adiv.Rdata")

load("plots/adiv/alpha_d08/adiv_Cecum_d08.Rdata")
# renaming
p.eve.8 <- p.eve
p.obs.8 <- p.obs
p.sha.8 <- p.sha
p.fpd.8 <- p.fpd
load("plots/adiv/alpha_d21/adiv_Cecum_d21.Rdata")
p.eve.21 <- p.eve
p.obs.21 <- p.obs
p.sha.21 <- p.sha
p.fpd.21 <- p.fpd
rm(p.eve,p.sha,p.obs,p.fpd)

load("plots/bdiv/timeline/Cecum_HF/PCoA_plot_Cecum_HF.Rdata")
#Renaming bdiv HF plots
hf.bray.perm <- bray.perm
hf.bray.plot <- rm_legend(bray.plot)
hf.jac.perm <- jac.perm
hf.jac.plot <- rm_legend(jac.plot)
hf.unif.perm <- unif.perm
hf.unif.plot <- rm_legend(unif.plot)
hf.wuf.perm <- wuf.perm
hf.wuf.plot <- rm_legend(wuf.plot)
hf.ait.perm <- ait.perm
hf.ait.plot <- rm_legend(ait.plot)

# Load bdiv LF plots
load("plots/bdiv/timeline/Cecum_LF/PCoA_plot_Cecum_LF.Rdata")

#Renaming bdiv HF plots
lf.bray.perm <- bray.perm
lf.bray.plot <- rm_legend(bray.plot)
lf.jac.perm <- jac.perm
lf.jac.plot <- rm_legend(jac.plot)
lf.unif.perm <- unif.perm
lf.unif.plot <- rm_legend(unif.plot)
lf.wuf.perm <- wuf.perm
lf.wuf.plot <- rm_legend(wuf.plot)
lf.ait.perm <- ait.perm
lf.ait.plot <- rm_legend(ait.plot)

load("plots/bdiv/timeline/Cecum/PCoA_plot_Cecum.Rdata")

legend <- get_legend(bray.plot)

#remove leftovers
rm(bray.perm,bray.plot,jac.perm,jac.plot,unif.perm,unif.plot,wuf.perm,wuf.plot,ait.perm,ait.plot)

# Call plots
p.adiv <- ggarrange(p.obs.8,p.sha.8,p.fpd.8, p.obs.21,p.sha.21,p.fpd.21, 
                    nrow = 2, ncol = 3,
                    labels = c("A","","","B","",""),
                    common.legend = TRUE,
                    align = "hv",
                    legend = "top",
                    font.label = list(size = 24, face = "bold"))
p.adiv

p.bdiv <- ggarrange(hf.bray.plot, hf.jac.plot, lf.bray.plot, lf.jac.plot,
                   ncol = 2, nrow = 2,
                   align = "hv",
                   label.x = 0,
                   font.label = list(size = 24, face = "bold"),
                   labels = c("C","D","E","F"))
p.bdiv

p.all <- ggarrange(p.adiv, legend, p.bdiv,
                   ncol = 1, nrow = 3,
                   heights = c(3,0.5,4))
p.all

# Save combined graphics
ggsave(filename = "plots/figures/diversity_cecum_combined_bray_jac.png", p.all, device = "png", dpi = 300, height = 350, width = 350, units = "mm")
ggsave(filename = "plots/figures/diversity_cecum_combined_bray_jac.pdf", p.all, device = "pdf", dpi = 300, height = 350, width = 350, units = "mm")

# clear the environment and release memory
rm(list = ls(all.names = TRUE)[ls(all.names = TRUE) != "params"])
invisible(gc())

```









# SETTINGS {.tabset .tabset-fade .tabset-pills}

Overview of the parameters and packages that were used for this analysis

## PARAMETERS

The following paramenters were set in for this analysis:

```{r parameters, eval=TRUE}
params <- readRDS("R_objects/Adiv_params.RDS")

tmp <- unlist(params)
dat <- data.frame(Parameter = names(tmp), Value = unname(tmp))


kbl(dat, row.names = F) %>% kable_classic(lightable_options = "striped")

```

## PACKAGES

The analysis was run in R version `r getRversion()` using the following packages:

```{r packages, eval=TRUE}
pack <- data.frame(Package = (.packages()))

for (i in seq(nrow(pack))) pack$Version[i] <- as.character(packageVersion(pack$Package[i]))

kbl(pack[order(pack$Package),], row.names = F) %>% kable_classic(lightable_options = "striped")   
     
```
